# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************

"""
Integration Tests
"""

load("@bazel_tools_python//quality:defs.bzl", "py_pytest")
load("@score_itf//:defs.bzl", "py_itf_test")

# Export vsomeip config for QEMU deployment
exports_files(
    ["vsomeip.json"],
    visibility = ["//visibility:public"],
)

py_pytest(
    name = "integration",
    size = "medium",
    srcs = glob(
        ["test_*.py"],
        exclude = ["test_qemu_*.py", "test_ssh.py"],
        allow_empty = True,
    ),
    data = ["vsomeip-local.json"],
    # Restrict the test execution to Linux for the moment due to dependency on Python
    target_compatible_with = ["@platforms//os:linux"],
    deps = [
        "//src/someipd",
        "@someip_pip//pytest",
        "@someip_pip//someip",
    ],
    target_compatible_with = ["@platforms//os:linux"],
)

# ---------------------------------------------------------------------------
# SSH connectivity test for QNX QEMU image
# QEMU is automatically started by the test fixture
# Run: bazel test //tests/integration:test_ssh --test_output=all
#
# NOTE: py_itf_test doesn't support 'deps', so common modules are included via srcs.
# See: https://github.com/bazelbuild/rules_python/blob/main/python/runfiles/README.md
# ---------------------------------------------------------------------------
py_itf_test(
    name = "test_ssh",
    srcs = [
        "test_ssh.py",
        "//tests/itf_updates:qemu_utils.py",
    ],
    data = [
        "//deployment/qemu:someip_gateway_ifs",
        "//deployment/qemu:run_qemu.sh",
    ],
    tags = ["qemu"],
)

# ---------------------------------------------------------------------------
# Single QEMU instance network test (SLIRP)
# Tests host connectivity via SLIRP networking
# ---------------------------------------------------------------------------
py_itf_test(
    name = "test_qemu_network_single",
    srcs = [
        "test_qemu_network.py",
        "//tests/itf_updates:qemu_utils.py",
    ],
    args = ["-k", "TestSingleInstanceNetwork"],
    data = [
        "//deployment/qemu:someip_gateway_ifs",
        "//deployment/qemu:run_qemu.sh",
    ],
    tags = ["qemu"],
)

# ---------------------------------------------------------------------------
# Dual QEMU instance network test (socket inter-QEMU)
# Tests communication between two QEMU instances
# ---------------------------------------------------------------------------
py_itf_test(
    name = "test_qemu_network_dual",
    srcs = [
        "test_qemu_network.py",
        "//tests/itf_updates:qemu_utils.py",
    ],
    args = ["-k", "TestDualInstanceNetwork"],
    data = [
        "//deployment/qemu:someip_gateway_ifs",
        "//deployment/qemu:run_qemu.sh",
    ],
    tags = ["qemu"],
)
